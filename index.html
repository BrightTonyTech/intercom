<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InterTask â€” Trac Network Task Board</title>
  <style>
    :root {
      --bg: #0d0d0f;
      --surface: #17181c;
      --surface2: #21222a;
      --border: #2a2b35;
      --accent: #7c5cfc;
      --accent2: #4cc9f0;
      --green: #3ddc97;
      --red: #f05564;
      --yellow: #f5c842;
      --text: #e8e8f0;
      --muted: #6b6c7e;
      --radius: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px; height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 18px;
    }

    header h1 { font-size: 17px; font-weight: 700; }
    header p  { font-size: 11px; color: var(--muted); }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--muted);
      margin-left: auto;
      transition: background 0.3s;
    }
    .status-dot.connected { background: var(--green); }

    .peer-id {
      font-size: 11px;
      color: var(--muted);
      font-family: monospace;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    aside {
      width: 220px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    aside h3 {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
      padding: 0 8px;
    }

    .nav-btn {
      background: none;
      border: none;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 7px;
      cursor: pointer;
      text-align: left;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }
    .nav-btn:hover { background: var(--surface2); }
    .nav-btn.active { background: var(--accent); color: #fff; }

    .badge {
      margin-left: auto;
      background: var(--surface2);
      border-radius: 20px;
      padding: 1px 7px;
      font-size: 11px;
      color: var(--muted);
      min-width: 22px;
      text-align: center;
    }
    .nav-btn.active .badge { background: rgba(255,255,255,0.2); color: #fff; }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
    }

    .toolbar h2 { font-size: 15px; font-weight: 600; }

    .btn {
      padding: 7px 14px;
      border-radius: 7px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: opacity 0.15s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: var(--accent); color: #fff; margin-left: auto; }
    .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }

    /* â”€â”€ Task list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .task-list::-webkit-scrollbar { width: 5px; }
    .task-list::-webkit-scrollbar-track { background: transparent; }
    .task-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

    .task-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .task-card:hover {
      border-color: var(--accent);
      background: var(--surface2);
    }

    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .task-id {
      font-family: monospace;
      font-size: 11px;
      color: var(--muted);
      padding-top: 2px;
      min-width: 70px;
    }

    .task-title {
      flex: 1;
      font-weight: 600;
      font-size: 14px;
      line-height: 1.4;
    }

    .status-pill {
      padding: 2px 9px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .status-open      { background: rgba(76,201,240,0.15); color: var(--accent2); }
    .status-completed { background: rgba(61,220,151,0.15); color: var(--green); }
    .status-cancelled { background: rgba(240,85,100,0.15); color: var(--red); }

    .task-meta {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      padding-left: 80px;
      font-size: 12px;
      color: var(--muted);
    }

    .task-desc {
      margin-top: 6px;
      padding-left: 80px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-state h3 { font-size: 16px; margin-bottom: 6px; color: var(--text); }

    /* â”€â”€ Chat panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-panel {
      width: 280px;
      border-left: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

    .chat-msg {
      background: var(--surface2);
      border-radius: 8px;
      padding: 8px 10px;
    }

    .chat-msg .from {
      font-size: 10px;
      color: var(--accent);
      font-family: monospace;
      margin-bottom: 3px;
    }
    .chat-msg.system .from { color: var(--yellow); }
    .chat-msg .text { font-size: 12px; line-height: 1.45; }

    .chat-input-row {
      display: flex;
      gap: 6px;
      padding: 10px;
      border-top: 1px solid var(--border);
    }

    .chat-input-row input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      padding: 7px 10px;
      font-size: 12px;
      outline: none;
    }
    .chat-input-row input:focus { border-color: var(--accent); }

    .chat-input-row button {
      background: var(--accent);
      border: none;
      border-radius: 7px;
      color: #fff;
      padding: 7px 12px;
      cursor: pointer;
      font-size: 12px;
    }

    /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      width: 460px;
      max-width: 95vw;
    }

    .modal h3 { font-size: 16px; margin-bottom: 18px; }

    .field { margin-bottom: 14px; }
    .field label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 5px; }
    .field input,
    .field textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      padding: 9px 12px;
      font-size: 13px;
      outline: none;
      resize: vertical;
      font-family: inherit;
    }
    .field input:focus,
    .field textarea:focus { border-color: var(--accent); }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-bar {
      display: flex;
      gap: 2px;
      padding: 0 20px 0 20px;
      height: 4px;
      border-bottom: 1px solid var(--border);
    }

    .stats-seg {
      height: 4px;
      transition: width 0.4s ease;
    }

    .seg-open { background: var(--accent2); }
    .seg-done { background: var(--green); }
    .seg-cancelled { background: var(--muted); }
  </style>
</head>
<body>

<header>
  <div class="logo">âœ“</div>
  <div>
    <h1>InterTask</h1>
    <p>Trac Network Â· Decentralized Task Board</p>
  </div>
  <span class="peer-id" id="peerId">connectingâ€¦</span>
  <div class="status-dot" id="statusDot"></div>
</header>

<div class="layout">

  <!-- Sidebar -->
  <aside>
    <h3>Filter</h3>
    <button class="nav-btn active" onclick="setFilter('all', this)">
      ğŸ“‹ All Tasks <span class="badge" id="cnt-all">0</span>
    </button>
    <button class="nav-btn" onclick="setFilter('open', this)">
      ğŸ”µ Open <span class="badge" id="cnt-open">0</span>
    </button>
    <button class="nav-btn" onclick="setFilter('completed', this)">
      âœ… Completed <span class="badge" id="cnt-completed">0</span>
    </button>
    <button class="nav-btn" onclick="setFilter('cancelled', this)">
      âŒ Cancelled <span class="badge" id="cnt-cancelled">0</span>
    </button>

    <h3 style="margin-top:16px">Assigned to me</h3>
    <button class="nav-btn" onclick="setFilter('mine', this)">
      ğŸ‘¤ My Tasks <span class="badge" id="cnt-mine">0</span>
    </button>
  </aside>

  <!-- Main content -->
  <main>
    <div class="toolbar">
      <h2 id="viewTitle">All Tasks</h2>
      <button class="btn btn-primary" onclick="openNewTaskModal()">+ New Task</button>
    </div>

    <div class="stats-bar">
      <div class="stats-seg seg-open"  id="seg-open"  style="width:33%"></div>
      <div class="stats-seg seg-done"  id="seg-done"  style="width:33%"></div>
      <div class="stats-seg seg-cancelled" id="seg-cancelled" style="width:34%"></div>
    </div>

    <div class="task-list" id="taskList">
      <div class="empty-state">
        <h3>No tasks yet</h3>
        <p>Create your first task to get started.</p>
      </div>
    </div>
  </main>

  <!-- Chat panel -->
  <div class="chat-panel">
    <div class="chat-header">ğŸ’¬ Sidechannel Chat</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="Send a messageâ€¦" onkeydown="if(event.key==='Enter') sendChat()" />
      <button onclick="sendChat()">Send</button>
    </div>
  </div>

</div>

<!-- New Task Modal -->
<div class="modal-overlay" id="newTaskModal">
  <div class="modal">
    <h3>Create New Task</h3>
    <div class="field">
      <label>Title *</label>
      <input id="newTitle" type="text" placeholder="What needs to be done?" maxlength="140" />
    </div>
    <div class="field">
      <label>Description</label>
      <textarea id="newDesc" rows="3" placeholder="Optional detailsâ€¦"></textarea>
    </div>
    <div class="field">
      <label>Assign to (peer address)</label>
      <input id="newAssignee" type="text" placeholder="Optional peer address" />
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitNewTask()">Create Task</button>
    </div>
  </div>
</div>

<script type="module">
import { createDesktopPeer } from 'trac-peer/desktop'
import './contract/protocol.js'

// Bootstrap config â€” replace after first deploy
const BOOTSTRAP_ADDRESS = 'REPLACE_WITH_YOUR_BOOTSTRAP_WRITER_KEY'
const CHANNEL = 'intertask-v1-mainnet-0000000'

let peer = null
let myAddress = null
let currentFilter = 'all'

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot () {
  try {
    peer = await createDesktopPeer({
      bootstrap_address: BOOTSTRAP_ADDRESS,
      channel: CHANNEL
    }, await import('./contract/protocol.js'))

    myAddress = peer.address

    document.getElementById('peerId').textContent = myAddress.slice(0, 20) + 'â€¦'
    document.getElementById('statusDot').classList.add('connected')

    addChatMsg('system', 'sys', `Connected Â· ${myAddress.slice(0, 16)}â€¦`)

    // Live sidechannel messages
    peer.on('message', ({ from, data }) => {
      try {
        const msg = JSON.parse(data)
        if (msg.type === 'task_update') {
          addChatMsg('system', 'update', `Task ${msg.id} â†’ ${msg.status}`)
          loadTasks()
        } else if (msg.type === 'chat') {
          addChatMsg('peer', from.slice(0, 12) + 'â€¦', msg.text)
        }
      } catch (_) {}
    })

    await loadTasks()
    setInterval(loadTasks, 10000)

  } catch (e) {
    document.getElementById('peerId').textContent = 'Error: ' + e.message
  }
}

// â”€â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTasks () {
  if (!peer) return
  try {
    const params = {}
    if (currentFilter === 'mine') {
      params.assignee = myAddress
    } else if (currentFilter !== 'all') {
      params.status = currentFilter
    }

    const res = await peer.view({ method: 'list_tasks', params })
    const tasks = res?.tasks ?? []

    // Update stats
    const stats = await peer.view({ method: 'stats', params: {} })
    const total = stats.total || 1
    document.getElementById('cnt-all').textContent       = stats.total
    document.getElementById('cnt-open').textContent      = stats.open
    document.getElementById('cnt-completed').textContent = stats.completed
    document.getElementById('cnt-cancelled').textContent = stats.cancelled

    const w = (n) => Math.max(1, Math.round((n / total) * 100)) + '%'
    document.getElementById('seg-open').style.width      = w(stats.open)
    document.getElementById('seg-done').style.width      = w(stats.completed)
    document.getElementById('seg-cancelled').style.width = w(stats.cancelled)

    renderTasks(tasks)
  } catch (e) {
    console.error('loadTasks:', e)
  }
}

function renderTasks (tasks) {
  const list = document.getElementById('taskList')
  if (!tasks.length) {
    list.innerHTML = `<div class="empty-state"><h3>No tasks here</h3><p>Change the filter or create a new task.</p></div>`
    return
  }

  list.innerHTML = tasks.map(t => {
    const assignee = t.assignee ? t.assignee.slice(0, 16) + 'â€¦' : 'Unassigned'
    const creator  = t.creator ? t.creator.slice(0, 16) + 'â€¦' : '?'
    const date     = new Date(t.created_at).toLocaleDateString()
    const isOpen   = t.status === 'open'
    const isActonable = isOpen && (t.creator === myAddress || t.assignee === myAddress)

    return `
    <div class="task-card" onclick="expandTask('${t.id}')">
      <div class="task-header">
        <span class="task-id">${t.id}</span>
        <span class="task-title">${escHtml(t.title)}</span>
        <span class="status-pill status-${t.status}">${t.status}</span>
      </div>
      ${t.desc ? `<div class="task-desc">${escHtml(t.desc.slice(0, 100))}${t.desc.length > 100 ? 'â€¦' : ''}</div>` : ''}
      <div class="task-meta">
        <span>ğŸ‘¤ ${assignee}</span>
        <span>ğŸ–Š ${creator}</span>
        <span>ğŸ“… ${date}</span>
        ${isActonable ? `
          <span style="margin-left:auto;display:flex;gap:6px;">
            <button class="btn btn-ghost" style="padding:3px 10px;font-size:11px;" onclick="event.stopPropagation();completeTask('${t.id}')">Complete</button>
            <button class="btn btn-ghost" style="padding:3px 10px;font-size:11px;color:var(--red);" onclick="event.stopPropagation();cancelTask('${t.id}')">Cancel</button>
          </span>` : ''}
      </div>
    </div>`
  }).join('')
}

window.expandTask = function (id) { /* future: show detail modal */ }

window.completeTask = async function (id) {
  if (!peer) return
  try {
    await peer.transaction({ method: 'complete_task', params: { id } })
    loadTasks()
  } catch (e) { alert('Error: ' + e.message) }
}

window.cancelTask = async function (id) {
  if (!peer) return
  if (!confirm('Cancel this task?')) return
  try {
    await peer.transaction({ method: 'cancel_task', params: { id } })
    loadTasks()
  } catch (e) { alert('Error: ' + e.message) }
}

// â”€â”€â”€ New task modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openNewTaskModal = function () {
  document.getElementById('newTaskModal').classList.add('open')
  document.getElementById('newTitle').focus()
}

window.closeModal = function () {
  document.getElementById('newTaskModal').classList.remove('open')
}

window.submitNewTask = async function () {
  const title    = document.getElementById('newTitle').value.trim()
  const desc     = document.getElementById('newDesc').value.trim()
  const assignee = document.getElementById('newAssignee').value.trim() || null
  if (!title) { alert('Title is required'); return }
  if (!peer) return
  try {
    await peer.transaction({ method: 'add_task', params: { title, desc, assignee } })
    document.getElementById('newTitle').value = ''
    document.getElementById('newDesc').value = ''
    document.getElementById('newAssignee').value = ''
    closeModal()
    loadTasks()
  } catch (e) { alert('Error: ' + e.message) }
}

// â”€â”€â”€ Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setFilter = function (filter, btn) {
  currentFilter = filter
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'))
  btn.classList.add('active')
  const titles = { all: 'All Tasks', open: 'Open Tasks', completed: 'Completed', cancelled: 'Cancelled', mine: 'Assigned to Me' }
  document.getElementById('viewTitle').textContent = titles[filter]
  loadTasks()
}

// â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.sendChat = async function () {
  const input = document.getElementById('chatInput')
  const text = input.value.trim()
  if (!text || !peer) return
  try {
    await peer.send(JSON.stringify({ type: 'chat', text }))
    addChatMsg('me', 'me', text)
    input.value = ''
  } catch (e) { console.error(e) }
}

function addChatMsg (cls, from, text) {
  const box = document.getElementById('chatMessages')
  const div = document.createElement('div')
  div.className = `chat-msg ${cls}`
  div.innerHTML = `<div class="from">${escHtml(from)}</div><div class="text">${escHtml(text)}</div>`
  box.appendChild(div)
  box.scrollTop = box.scrollHeight
}

function escHtml (s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')
}

boot()
</script>

</body>
</html>
